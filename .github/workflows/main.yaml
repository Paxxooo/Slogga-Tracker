name: Download and Convert Habbo Files

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-node@v2
        with:
          node-version: 16

      - name: Install dependencies
        run: npm i

      # Download various resources
      - name: Download News Article Images
        run: node src/index.js -c articles

      - name: Download Badgeparts Images
        run: node src/index.js -c badgeparts

      - name: Download Badges
        run: node src/index.js -c badges

      - name: Download Clothes
        run: node src/index.js -c clothes

      - name: Download Effects
        run: node src/index.js -c effects

      - name: Download Furniture Icons
        run: node src/index.js -c ficons

      - name: Download Furnitures
        run: node src/index.js -c furnitures

      - name: Download Gamedata Files
        run: node src/index.js -c gamedata

      - name: Download Gordon Files
        run: node src/index.js -c gordon

      - name: Download Habbo.swf
        run: node src/index.js -c habboswf

      - name: Download Hotelview Images
        run: node src/index.js -c hotelview

      - name: Download Catalogue Icons
        run: node src/index.js -c icons

      - name: Download MP3 Files
        run: node src/index.js -c mp3

      - name: Download Pets
        run: node src/index.js -c pets

      - name: Download Web Promo Images
        run: node src/index.js -c promo

      - name: Install SWFTools
        run: sudo apt-get install swftools

      - name: Extract and Rename PNG from SWF
        run: |
          mkdir -p ./resource/dcr/hof_furni/png
          for swf in ./resource/dcr/hof_furni/*.swf; do
            swfextract -p 1 "$swf" -o "${swf%.swf}.png"
            mv "${swf%.swf}.png" ./resource/dcr/hof_furni/png/
          done

      # Add and commit changes
      - uses: EndBug/add-and-commit@v7
        with:
          default_author: github_actions
          add: 'resource/dcr/hof_furni/png'

      - name: Get Last Commit Info
        id: last_commit
        run: |
          echo "::set-output name=message::$(git log -1 --pretty=format:'%B')"
          echo "::set-output name=diff::$(git diff HEAD~1 HEAD)"

      - name: Send Discord Notification
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"username\": \"GitHub Actions\", \"content\": \"Ultimo commit: \n${{ steps.last_commit.outputs.message }}\nDiff:\n${{ steps.last_commit.outputs.diff }}\"}" \
          ${{ secrets.DISCORD_WEBHOOK_URL }}
